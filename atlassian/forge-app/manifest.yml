---
# Atlassian Forge App Manifest - FirstTry Governance Dual Layer
# PHASE 1: Event ingestion endpoint with token auth, validation, idempotency, storage
# PHASE 1.1: Storage proof debug endpoint (admin-only)
# PHASE 3: Scheduled daily/weekly pipelines, run ledgers, readiness gating
# Schema: Forge CLI v12+ for Jira Cloud

app:
  id: ari:cloud:ecosystem::app/59d86182-c1c6-49ea-b2fb-6ee5be52b7fc
  description: FirstTry Governance - Atlassian Dual-Layer Integration
  runtime:
    name: nodejs20.x

# Modules
modules:
  # Dashboard Gadget (PHASE 0: Static placeholder)
  jira:dashboardGadget:
    - key: governance-dashboard-gadget
      title: FirstTry Governance Status
      description: FirstTry Governance - real-time status overview
      resource: governance-gadget-page
      resolver:
        function: status-resolver-fn
      thumbnail: https://www.atlassian.com/favicon.ico

  # Function modules (PHASE 3: Scheduled pipeline handlers, PHASE 5: Scheduler, PHASE 6: Snapshot evidence ledger, SEV-2-003: OAuth refresh)
  function:
    - key: phase5-scheduler-fn
      handler: scheduled/phase5_scheduler.run
    - key: phase6-daily-snap-fn
      handler: scheduled/snapshot_daily.handle
    - key: phase6-weekly-snap-fn
      handler: scheduled/snapshot_weekly.handle
    - key: token-refresh-job-fn
      handler: scheduled/token_refresh_scheduler.handle
    - key: status-resolver-fn
      handler: resolvers/governance_status.get

  # PHASE 3: Scheduled Pipelines (interval-based, valid Forge module)
  # PHASE 5: Automatic trigger scheduler (fiveMinute interval to catch thresholds quickly)
  # PHASE 6: Snapshot evidence ledger (daily + weekly automatic captures)
  # SEV-2-003: OAuth token refresh (every 12 hours to prevent expiry gaps)
  scheduledTrigger:
    - key: phase5-auto-scheduler
      function: phase5-scheduler-fn
      interval: fiveMinute

    - key: phase6-daily-snapshot
      function: phase6-daily-snap-fn
      interval: day

    - key: phase6-weekly-snapshot
      function: phase6-weekly-snap-fn
      interval: week

    - key: token-refresh-job
      function: token-refresh-job-fn
      interval: hour

# Permissions
permissions:
  scopes:
    - storage:app
    - read:jira-work

# Resource pages
resources:
  - key: governance-gadget-page
    path: src/gadget-ui
